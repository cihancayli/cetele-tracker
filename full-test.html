<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cetele Full System Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Monaco', 'Menlo', monospace;
            background: #0d0d1a;
            color: #00ff00;
            padding: 20px;
            min-height: 100vh;
        }
        h1 { color: #00ffff; margin-bottom: 10px; }
        .subtitle { color: #888; margin-bottom: 20px; }
        .console {
            background: #000;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 15px;
            height: 70vh;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 12px;
            line-height: 1.4;
        }
        .error { color: #ff4444; }
        .success { color: #00ff00; }
        .info { color: #00ffff; }
        .warn { color: #ffaa00; }
        .header { color: #ff00ff; font-weight: bold; }
        .dim { color: #666; }
        .buttons { margin: 15px 0; display: flex; gap: 10px; flex-wrap: wrap; }
        button {
            background: #00aaff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
        }
        button:hover { background: #0088cc; }
        button:disabled { background: #333; cursor: not-allowed; }
        .btn-green { background: #00aa00; }
        .btn-green:hover { background: #008800; }
        .btn-red { background: #aa0000; }
        .btn-red:hover { background: #880000; }
        .btn-yellow { background: #aa8800; }
        .btn-yellow:hover { background: #886600; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Cetele Full System Test</h1>
    <p class="subtitle">Click "Run All Tests" then copy the console output</p>

    <div class="buttons">
        <button class="btn-green" onclick="runAllTests()" id="runBtn">â–¶ Run All Tests</button>
        <button onclick="copyConsole()">ğŸ“‹ Copy Console</button>
        <button onclick="clearConsole()">ğŸ—‘ Clear</button>
        <button class="btn-yellow" onclick="fixRLS()">ğŸ”§ Fix RLS (run if insert fails)</button>
    </div>

    <div class="console" id="console"></div>

    <script src="js/supabase-config.js"></script>
    <script>
        const output = document.getElementById('console');

        function log(msg, type = 'info') {
            const ts = new Date().toLocaleTimeString();
            output.innerHTML += `<span class="${type}">[${ts}] ${msg}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }

        function header(msg) {
            output.innerHTML += `\n<span class="header">â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>\n`;
            output.innerHTML += `<span class="header">${msg}</span>\n`;
            output.innerHTML += `<span class="header">â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>\n\n`;
        }

        function clearConsole() {
            output.innerHTML = '';
        }

        function copyConsole() {
            const text = output.innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert('Console copied to clipboard!');
            });
        }

        async function runAllTests() {
            const btn = document.getElementById('runBtn');
            btn.disabled = true;
            btn.textContent = 'â³ Running...';
            clearConsole();

            log('ğŸš€ Starting Cetele Full System Test', 'header');
            log(`Supabase URL: ${SUPABASE_URL}`, 'dim');
            log(`Timestamp: ${new Date().toISOString()}`, 'dim');

            try {
                await test1_SchemaCheck();
                await test2_RegionsCheck();
                await test3_ActivitiesCheck();
                await test4_UsersCheck();
                await test5_GroupsCheck();
                await test6_MentorCodesCheck();
                await test7_RLSCheck();
                await test8_CreateCoordinator();
                await test9_CreateStudent();
                await test10_SubmitCetele();
                await test11_VerifySubmission();
                await test12_Cleanup();

                header('âœ… ALL TESTS COMPLETE');
            } catch (err) {
                log(`\nğŸ’¥ FATAL ERROR: ${err.message}`, 'error');
                log(err.stack, 'dim');
            }

            btn.disabled = false;
            btn.textContent = 'â–¶ Run All Tests';
        }

        // Test 1: Schema Check
        async function test1_SchemaCheck() {
            header('TEST 1: Schema Check');

            const tables = ['users', 'regions', 'groups', 'students', 'activities', 'weekly_submissions', 'mentor_codes'];

            for (const table of tables) {
                const { data, error } = await supabase.from(table).select('*').limit(1);
                if (error) {
                    log(`âŒ ${table}: ${error.message}`, 'error');
                } else {
                    const cols = data && data[0] ? Object.keys(data[0]).join(', ') : '(empty table)';
                    log(`âœ… ${table}: ${cols}`, 'success');
                }
            }

            // Check specific required columns
            log('\nChecking required columns...', 'info');

            const { data: userCols } = await supabase.from('users').select('division, region_id').limit(1);
            if (userCols !== null) {
                log('âœ… users.division exists', 'success');
                log('âœ… users.region_id exists', 'success');
            }

            const { data: groupCols } = await supabase.from('groups').select('division, region_id, mentor_id').limit(1);
            if (groupCols !== null) {
                log('âœ… groups.division exists', 'success');
                log('âœ… groups.region_id exists', 'success');
                log('âœ… groups.mentor_id exists', 'success');
            }
        }

        // Test 2: Regions Check
        async function test2_RegionsCheck() {
            header('TEST 2: Regions');

            const { data, error } = await supabase.from('regions').select('*');

            if (error) {
                log(`âŒ Error: ${error.message}`, 'error');
                return;
            }

            if (!data || data.length === 0) {
                log('âŒ No regions found!', 'error');
                log('FIX: Run setup-regions-system.sql', 'warn');
                return;
            }

            log(`Found ${data.length} region(s):`, 'success');
            data.forEach(r => {
                log(`  ğŸ“ ${r.name}`, 'info');
                log(`     ED: ${r.ed_code}`, 'dim');
                log(`     HS: ${r.hs_code}`, 'dim');
                log(`     MS: ${r.ms_code}`, 'dim');
            });
        }

        // Test 3: Activities Check
        async function test3_ActivitiesCheck() {
            header('TEST 3: Activities');

            const { data, error } = await supabase.from('activities').select('*').order('order_index');

            if (error) {
                log(`âŒ Error: ${error.message}`, 'error');
                return;
            }

            log(`Found ${data?.length || 0} activities:`, 'success');
            data?.forEach(a => {
                log(`  ${a.order_index}. ${a.name} - ${a.description}`, 'dim');
            });
        }

        // Test 4: Users Check
        async function test4_UsersCheck() {
            header('TEST 4: Existing Users');

            const { data, error } = await supabase
                .from('users')
                .select('username, role, division, region_id, is_coordinator, is_mentor');

            if (error) {
                log(`âŒ Error: ${error.message}`, 'error');
                return;
            }

            log(`Found ${data?.length || 0} users:`, 'success');
            data?.forEach(u => {
                log(`  ğŸ‘¤ ${u.username} | role=${u.role} | div=${u.division || 'NULL'} | coord=${u.is_coordinator} | mentor=${u.is_mentor}`, 'dim');
            });
        }

        // Test 5: Groups Check
        async function test5_GroupsCheck() {
            header('TEST 5: Groups');

            const { data, error } = await supabase
                .from('groups')
                .select('name, grade, division, region_id, mentor_id');

            if (error) {
                log(`âŒ Error: ${error.message}`, 'error');
                return;
            }

            log(`Found ${data?.length || 0} groups:`, 'success');
            data?.forEach(g => {
                log(`  ğŸ“ ${g.name} | grade=${g.grade} | div=${g.division || 'NULL'} | mentor=${g.mentor_id ? 'YES' : 'NO'}`, 'dim');
            });
        }

        // Test 6: Mentor Codes Check
        async function test6_MentorCodesCheck() {
            header('TEST 6: Mentor Codes');

            const { data, error } = await supabase
                .from('mentor_codes')
                .select('code, mentor_id, group_id, is_active');

            if (error) {
                log(`âŒ Error: ${error.message}`, 'error');
                return;
            }

            log(`Found ${data?.length || 0} mentor codes:`, 'success');
            data?.forEach(mc => {
                log(`  ğŸ”‘ ${mc.code} | active=${mc.is_active} | group=${mc.group_id ? 'YES' : 'NO'}`, 'dim');
            });
        }

        // Test 7: RLS Check
        async function test7_RLSCheck() {
            header('TEST 7: Row Level Security (RLS) Check');

            // Test SELECT (should work)
            const { error: selectError } = await supabase.from('users').select('id').limit(1);
            if (selectError) {
                log(`âŒ SELECT on users: ${selectError.message}`, 'error');
            } else {
                log('âœ… SELECT on users: OK', 'success');
            }

            // Test INSERT with a dummy that we'll rollback
            const testId = crypto.randomUUID();
            const { error: insertError } = await supabase
                .from('users')
                .insert([{
                    id: testId,
                    username: '_rls_test_' + Date.now(),
                    password_hash: 'test',
                    role: 'student',
                    student_id: null
                }]);

            if (insertError) {
                if (insertError.message.includes('row-level security')) {
                    log(`âŒ INSERT on users: RLS BLOCKED`, 'error');
                    log('   Anonymous inserts are not allowed', 'warn');
                    log('   FIX: Click "Fix RLS" button or run RLS fix SQL', 'warn');
                } else if (insertError.message.includes('student_must_have_student_id')) {
                    log('âœ… INSERT on users: OK (constraint working)', 'success');
                } else {
                    log(`âš ï¸ INSERT on users: ${insertError.message}`, 'warn');
                }
            } else {
                log('âœ… INSERT on users: OK', 'success');
                // Clean up
                await supabase.from('users').delete().eq('id', testId);
            }
        }

        // Test 8: Create Coordinator
        let testCoordinator = null;
        let testGroup = null;
        let testMentorCode = null;

        async function test8_CreateCoordinator() {
            header('TEST 8: Create Test Coordinator');

            const username = 'test_coord_' + Date.now();

            // Get region
            const { data: region, error: regionError } = await supabase
                .from('regions')
                .select('*')
                .eq('name', 'North Carolina')
                .single();

            if (regionError || !region) {
                log(`âŒ Region not found: ${regionError?.message}`, 'error');
                return;
            }

            log(`âœ… Found region: ${region.name} (${region.id})`, 'success');

            // Create coordinator
            const { data: user, error: userError } = await supabase
                .from('users')
                .insert([{
                    username: username,
                    password_hash: 'test123hash',
                    role: 'coordinator',
                    region_id: region.id,
                    division: 'High School',
                    is_coordinator: true,
                    is_mentor: true
                }])
                .select()
                .single();

            if (userError) {
                log(`âŒ Create user failed: ${userError.message}`, 'error');
                if (userError.message.includes('row-level security')) {
                    log('   RLS is blocking inserts. Run the Fix RLS button.', 'warn');
                }
                return;
            }

            testCoordinator = user;
            log(`âœ… Coordinator created: ${user.username} (${user.id})`, 'success');

            // Create group
            const { data: group, error: groupError } = await supabase
                .from('groups')
                .insert([{
                    name: 'Test Group ' + Date.now(),
                    grade: 'High School',
                    mentor_id: user.id,
                    region_id: region.id,
                    division: 'High School'
                }])
                .select()
                .single();

            if (groupError) {
                log(`âŒ Create group failed: ${groupError.message}`, 'error');
                return;
            }

            testGroup = group;
            log(`âœ… Group created: ${group.name} (${group.id})`, 'success');

            // Check for auto-generated mentor code
            const { data: mc } = await supabase
                .from('mentor_codes')
                .select('*')
                .eq('mentor_id', user.id)
                .single();

            if (mc) {
                testMentorCode = mc.code;
                // Update with group_id
                await supabase.from('mentor_codes').update({ group_id: group.id }).eq('id', mc.id);
                log(`âœ… Mentor code (auto): ${mc.code}`, 'success');
            } else {
                // Create manually
                testMentorCode = 'MTR-TEST-' + Date.now();
                const { error: mcError } = await supabase
                    .from('mentor_codes')
                    .insert([{
                        code: testMentorCode,
                        mentor_id: user.id,
                        group_id: group.id,
                        region_id: region.id,
                        is_active: true
                    }]);

                if (mcError) {
                    log(`âŒ Create mentor code failed: ${mcError.message}`, 'error');
                } else {
                    log(`âœ… Mentor code (manual): ${testMentorCode}`, 'success');
                }
            }
        }

        // Test 9: Create Student
        let testStudent = null;
        let testStudentUser = null;

        async function test9_CreateStudent() {
            header('TEST 9: Create Test Student');

            if (!testGroup || !testMentorCode) {
                log('â­ï¸ Skipped - no test group/mentor code', 'warn');
                return;
            }

            const studentName = 'Test Student ' + Date.now();

            // Get region from group
            const { data: region } = await supabase
                .from('regions')
                .select('*')
                .eq('name', 'North Carolina')
                .single();

            // Create student record
            const { data: student, error: studentError } = await supabase
                .from('students')
                .insert([{
                    name: studentName,
                    grade: 'High School',
                    group_id: testGroup.id,
                    region_id: region?.id
                }])
                .select()
                .single();

            if (studentError) {
                log(`âŒ Create student failed: ${studentError.message}`, 'error');
                return;
            }

            testStudent = student;
            log(`âœ… Student record created: ${student.name} (${student.id})`, 'success');

            // Create student user
            const { data: user, error: userError } = await supabase
                .from('users')
                .insert([{
                    username: 'student_' + Date.now(),
                    password_hash: 'student123hash',
                    role: 'student',
                    region_id: region?.id,
                    division: 'High School',
                    student_id: student.id,
                    mentor_id: testCoordinator?.id
                }])
                .select()
                .single();

            if (userError) {
                log(`âŒ Create student user failed: ${userError.message}`, 'error');
                return;
            }

            testStudentUser = user;
            log(`âœ… Student user created: ${user.username} (${user.id})`, 'success');

            // Link student to user
            await supabase.from('students').update({ user_id: user.id }).eq('id', student.id);
            log('âœ… Student linked to user', 'success');
        }

        // Test 10: Submit Cetele
        let testSubmission = null;

        async function test10_SubmitCetele() {
            header('TEST 10: Submit Cetele (Student â†’ System)');

            if (!testStudent) {
                log('â­ï¸ Skipped - no test student', 'warn');
                return;
            }

            // Get activities
            const { data: activities } = await supabase
                .from('activities')
                .select('id, name')
                .order('order_index');

            if (!activities || activities.length === 0) {
                log('âŒ No activities found', 'error');
                return;
            }

            // Create completions
            const completions = {};
            activities.forEach(a => {
                completions[a.id] = Math.floor(Math.random() * 10);
            });

            log(`ğŸ“ Activity completions:`, 'info');
            activities.forEach(a => {
                log(`   ${a.name}: ${completions[a.id]}`, 'dim');
            });

            // Week start (Sunday)
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            const weekStartStr = weekStart.toISOString().split('T')[0];

            log(`ğŸ“… Week: ${weekStartStr}`, 'info');

            // Submit
            const { data: submission, error } = await supabase
                .from('weekly_submissions')
                .upsert([{
                    student_id: testStudent.id,
                    week_start_date: weekStartStr,
                    activity_completions: completions
                }], { onConflict: 'student_id,week_start_date' })
                .select()
                .single();

            if (error) {
                log(`âŒ Submit failed: ${error.message}`, 'error');
                return;
            }

            testSubmission = submission;
            log(`âœ… Cetele submitted: ${submission.id}`, 'success');
        }

        // Test 11: Verify Submission (Coordinator View)
        async function test11_VerifySubmission() {
            header('TEST 11: Verify Submission (Coordinator View)');

            if (!testSubmission) {
                log('â­ï¸ Skipped - no test submission', 'warn');
                return;
            }

            // Fetch submission with student info
            const { data, error } = await supabase
                .from('weekly_submissions')
                .select(`
                    *,
                    students (
                        name,
                        grade,
                        groups (
                            name,
                            mentor_id
                        )
                    )
                `)
                .eq('id', testSubmission.id)
                .single();

            if (error) {
                log(`âŒ Fetch failed: ${error.message}`, 'error');
                return;
            }

            log('âœ… Submission found:', 'success');
            log(`   Student: ${data.students?.name}`, 'info');
            log(`   Group: ${data.students?.groups?.name}`, 'info');
            log(`   Week: ${data.week_start_date}`, 'info');
            log(`   Completions: ${JSON.stringify(data.activity_completions)}`, 'dim');

            // Verify it's visible to coordinator (same group)
            if (data.students?.groups?.mentor_id === testCoordinator?.id) {
                log('âœ… Coordinator can see this submission (same group)', 'success');
            }
        }

        // Test 12: Cleanup
        async function test12_Cleanup() {
            header('TEST 12: Cleanup Test Data');

            let cleaned = 0;

            if (testSubmission) {
                await supabase.from('weekly_submissions').delete().eq('id', testSubmission.id);
                log('ğŸ—‘ï¸ Deleted test submission', 'dim');
                cleaned++;
            }

            if (testStudentUser) {
                await supabase.from('users').delete().eq('id', testStudentUser.id);
                log('ğŸ—‘ï¸ Deleted test student user', 'dim');
                cleaned++;
            }

            if (testStudent) {
                await supabase.from('students').delete().eq('id', testStudent.id);
                log('ğŸ—‘ï¸ Deleted test student', 'dim');
                cleaned++;
            }

            if (testMentorCode && testCoordinator) {
                await supabase.from('mentor_codes').delete().eq('mentor_id', testCoordinator.id);
                log('ğŸ—‘ï¸ Deleted test mentor code', 'dim');
                cleaned++;
            }

            if (testGroup) {
                await supabase.from('groups').delete().eq('id', testGroup.id);
                log('ğŸ—‘ï¸ Deleted test group', 'dim');
                cleaned++;
            }

            if (testCoordinator) {
                await supabase.from('users').delete().eq('id', testCoordinator.id);
                log('ğŸ—‘ï¸ Deleted test coordinator', 'dim');
                cleaned++;
            }

            log(`âœ… Cleaned up ${cleaned} test records`, 'success');
        }

        // Fix RLS
        async function fixRLS() {
            header('ğŸ”§ RLS FIX INSTRUCTIONS');
            log('Copy and run this SQL in Supabase SQL Editor:', 'warn');
            log('', 'info');
            log(`-- Allow anonymous inserts for users table
DROP POLICY IF EXISTS "Allow insert for anonymous" ON users;
CREATE POLICY "Allow insert for anonymous" ON users FOR INSERT WITH CHECK (true);

-- Allow anonymous updates for users table
DROP POLICY IF EXISTS "Allow update for anonymous" ON users;
CREATE POLICY "Allow update for anonymous" ON users FOR UPDATE USING (true);

-- Allow anonymous deletes for users table (for testing)
DROP POLICY IF EXISTS "Allow delete for anonymous" ON users;
CREATE POLICY "Allow delete for anonymous" ON users FOR DELETE USING (true);

-- Same for groups
DROP POLICY IF EXISTS "Allow insert for anonymous" ON groups;
CREATE POLICY "Allow insert for anonymous" ON groups FOR INSERT WITH CHECK (true);
DROP POLICY IF EXISTS "Allow update for anonymous" ON groups;
CREATE POLICY "Allow update for anonymous" ON groups FOR UPDATE USING (true);
DROP POLICY IF EXISTS "Allow delete for anonymous" ON groups;
CREATE POLICY "Allow delete for anonymous" ON groups FOR DELETE USING (true);

-- Same for students
DROP POLICY IF EXISTS "Allow insert for anonymous" ON students;
CREATE POLICY "Allow insert for anonymous" ON students FOR INSERT WITH CHECK (true);
DROP POLICY IF EXISTS "Allow update for anonymous" ON students;
CREATE POLICY "Allow update for anonymous" ON students FOR UPDATE USING (true);
DROP POLICY IF EXISTS "Allow delete for anonymous" ON students;
CREATE POLICY "Allow delete for anonymous" ON students FOR DELETE USING (true);

-- Same for mentor_codes
DROP POLICY IF EXISTS "Allow insert for anonymous" ON mentor_codes;
CREATE POLICY "Allow insert for anonymous" ON mentor_codes FOR INSERT WITH CHECK (true);
DROP POLICY IF EXISTS "Allow update for anonymous" ON mentor_codes;
CREATE POLICY "Allow update for anonymous" ON mentor_codes FOR UPDATE USING (true);
DROP POLICY IF EXISTS "Allow delete for anonymous" ON mentor_codes;
CREATE POLICY "Allow delete for anonymous" ON mentor_codes FOR DELETE USING (true);`, 'dim');
        }
    </script>
</body>
</html>
