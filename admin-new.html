<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard ‚Äî Cetele Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <link rel="stylesheet" href="css/admin-new.css">
</head>
<body>
    <!-- Mobile Hamburger Menu Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleSidebar()">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
    </button>

    <!-- Mobile Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <span class="logo-icon">üìä</span>
                <span class="logo-text">Cetele Admin</span>
            </div>
            <div class="user-info">
                <div class="user-name" id="userName">Loading...</div>
                <div class="user-role" id="userRole">Loading...</div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-label">Main</div>
                <a href="#" class="nav-item active" data-page="overview">
                    <span class="nav-icon">üìà</span>
                    <span>Overview</span>
                </a>
                <a href="#" class="nav-item" data-page="analytics">
                    <span class="nav-icon">üìä</span>
                    <span>Analytics</span>
                </a>
                <a href="#" class="nav-item" data-page="hierarchy">
                    <span class="nav-icon">üå≥</span>
                    <span>Organization</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-label">Management</div>
                <a href="#" class="nav-item" data-page="groups">
                    <span class="nav-icon">üë•</span>
                    <span>Groups</span>
                </a>
                <a href="#" class="nav-item" data-page="students">
                    <span class="nav-icon">üéì</span>
                    <span>Students</span>
                </a>
                <a href="#" class="nav-item" data-page="cetele">
                    <span class="nav-icon">üìã</span>
                    <span>Weekly Cetele</span>
                </a>
                <a href="#" class="nav-item" data-page="activities">
                    <span class="nav-icon">üìä</span>
                    <span>Activities Summary</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-label">Settings</div>
                <a href="#" class="nav-item" data-page="mentor-code">
                    <span class="nav-icon">üîë</span>
                    <span>Mentor Code</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-footer">
            <button class="btn-logout" onclick="logout()">
                <span>üö™</span>
                <span>Sign Out</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Overview Page -->
        <div id="overviewPage" class="page active">
            <div class="page-header">
                <h1 class="page-title">Overview</h1>
                <p class="page-subtitle">Welcome back! Here's what's happening with your groups.</p>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card" style="animation-delay: 0.1s">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-label">Total Students</div>
                    <div class="stat-value" id="totalStudents">0</div>
                    <div class="stat-change positive">
                        <span>‚Üë</span>
                        <span id="studentsChange">0%</span>
                    </div>
                </div>

                <div class="stat-card" style="animation-delay: 0.2s">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-label">This Week's Completion</div>
                    <div class="stat-value" id="weekCompletion">0%</div>
                    <div class="stat-change" id="weekCompletionChange">
                        <span>‚Üí</span>
                        <span>0%</span>
                    </div>
                </div>

                <div class="stat-card" style="animation-delay: 0.3s">
                    <div class="stat-icon">üî•</div>
                    <div class="stat-label">Active Streaks</div>
                    <div class="stat-value" id="activeStreaks">0</div>
                    <div class="stat-change positive">
                        <span>‚Üë</span>
                        <span id="streaksChange">0</span>
                    </div>
                </div>

                <div class="stat-card" style="animation-delay: 0.4s">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-label">Average Score</div>
                    <div class="stat-value" id="avgScore">0</div>
                    <div class="stat-change" id="avgScoreChange">
                        <span>‚Üí</span>
                        <span>0</span>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span>üìà</span>
                            <span>Completion Trends</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="trendsChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span>üéØ</span>
                            <span>Activity Breakdown</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Performance Charts -->
            <div class="charts-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span>üèÜ</span>
                            <span>Top Performing Group</span>
                        </div>
                        <select class="form-select" id="topGroupTimeFilter" onchange="loadTopGroupChart()" style="width: auto;">
                            <option value="all">All Time</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="topGroupChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span>‚ö†Ô∏è</span>
                            <span>Needs Attention</span>
                        </div>
                        <select class="form-select" id="bottomGroupTimeFilter" onchange="loadBottomGroupChart()" style="width: auto;">
                            <option value="all">All Time</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="bottomGroupChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Top Students -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <div class="card-title">
                        <span>üåü</span>
                        <span>Top 3 Students</span>
                    </div>
                </div>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="topStudentsChart"></canvas>
                </div>
            </div>

            <!-- Recent Submissions -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span>üìã</span>
                        <span>Recent Submissions</span>
                    </div>
                    <button class="btn btn-sm" onclick="navigateTo('cetele')">View All</button>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Group</th>
                                <th>Week</th>
                                <th>Completion</th>
                                <th>Submitted</th>
                            </tr>
                        </thead>
                        <tbody id="recentSubmissionsBody">
                            <tr>
                                <td colspan="5" class="loading">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Analytics Page -->
        <div id="analyticsPage" class="page">
            <div class="page-header">
                <h1 class="page-title">Analytics</h1>
                <p class="page-subtitle">Deep dive into performance metrics and insights.</p>
            </div>

            <div class="charts-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span>üìä</span>
                            <span>Weekly Progress</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="weeklyProgressChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <span>üë•</span>
                            <span>Group Comparison</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="groupComparisonChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span>üèÜ</span>
                        <span>Top Performers</span>
                    </div>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Student</th>
                                <th>Group</th>
                                <th>Avg Completion</th>
                                <th>Streak</th>
                            </tr>
                        </thead>
                        <tbody id="topPerformersBody">
                            <tr>
                                <td colspan="5" class="loading">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Organization Page -->
        <div id="hierarchyPage" class="page">
            <div class="page-header">
                <h1 class="page-title">Organization</h1>
                <p class="page-subtitle">View your organization structure from ED to students.</p>
            </div>

            <div class="hierarchy-container" id="hierarchyContainer">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Groups Page -->
        <div id="groupsPage" class="page">
            <div class="page-header">
                <h1 class="page-title">Groups</h1>
                <p class="page-subtitle">Manage your groups and mentors.</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span>üë•</span>
                        <span>All Groups</span>
                    </div>
                    <button class="btn btn-primary" onclick="showCreateGroupModal()">
                        <span>+</span>
                        <span>Create Group</span>
                    </button>
                </div>
                <div id="groupsList">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Students Page -->
        <div id="studentsPage" class="page">
            <div class="page-header">
                <h1 class="page-title">Students</h1>
                <p class="page-subtitle">Manage student accounts and assignments.</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span>üéì</span>
                        <span>All Students</span>
                    </div>
                    <div class="card-actions">
                        <select class="form-select" id="filterGroup" onchange="filterStudents()">
                            <option value="">All Groups</option>
                        </select>
                        <button class="btn btn-primary" onclick="showAddStudentModal()">
                            <span>+</span>
                            <span>Add Student</span>
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Group</th>
                                <th>Grade</th>
                                <th>Completion Rate</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            <tr>
                                <td colspan="5" class="loading">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Weekly Cetele Page -->
        <div id="cetelePage" class="page">
            <div class="page-header">
                <h1 class="page-title">Weekly Cetele</h1>
                <p class="page-subtitle">View and manage weekly submissions.</p>
            </div>

            <!-- Week Selector -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem; justify-content: space-between;">
                    <button class="btn" onclick="changeCeteleWeek(-1)">‚Üê Previous Week</button>
                    <div style="text-align: center;">
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem;">Viewing Week of</div>
                        <div id="ceteleWeekDisplay" style="font-size: 1.1rem; font-weight: 600;">Loading...</div>
                    </div>
                    <button class="btn" onclick="changeCeteleWeek(1)">Next Week ‚Üí</button>
                </div>
            </div>

            <div id="ceteleTableContainer">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Mentor Code Page -->
        <div id="mentor-codePage" class="page">
            <div class="page-header">
                <h1 class="page-title">Mentor Codes</h1>
                <p class="page-subtitle" id="mentorCodeSubtitle">Share codes with students to join groups.</p>
            </div>

            <div id="mentorCodeContainer">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- Manage Cetele Page (Mentors Only) -->
        <div id="manageCetelePage" class="page" style="display: none;">
            <div class="page-header">
                <h1 class="page-title">Manage My Cetele</h1>
                <p class="page-subtitle">Customize activities for your group's weekly cetele.</p>
            </div>

            <div class="card" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <div class="card-title">
                        <span>üìù</span>
                        <span>My Group's Activities</span>
                    </div>
                    <button class="btn-add-activity" onclick="addNewActivity()">
                        <span>+</span> Add Custom Activity
                    </button>
                </div>
                <div id="activitiesListContainer">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <div class="info-box">
                <strong>üí° How it works:</strong> Your students will only see the activities you add to your cetele.
                Global activities are just suggestions from coordinators that you can adopt if you'd like.
                You have full control to create, edit, and delete your group's activities.
            </div>
        </div>

        <!-- Activities Summary Page -->
        <div id="activitiesPage" class="page">
            <div class="page-header">
                <h1 class="page-title">Activities Summary</h1>
                <p class="page-subtitle">View activity totals for each group and student.</p>
            </div>

            <!-- Summary Cards -->
            <div class="stats-grid" style="margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-label">Total Activities Completed</div>
                    <div class="stat-value" id="totalActivitiesCompleted">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üèÜ</div>
                    <div class="stat-label">Most Active Group</div>
                    <div class="stat-value" id="mostActiveGroup">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìà</div>
                    <div class="stat-label">Avg Completion Rate</div>
                    <div class="stat-value" id="avgCompletionRate">0%</div>
                </div>
            </div>

            <!-- Group Activities Summary -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span>üë•</span>
                        <span>Activity Totals by Group</span>
                    </div>
                    <select class="form-select" id="activitiesTimeFilter" onchange="loadActivitiesSummary()">
                        <option value="all">All Time</option>
                        <option value="this-week">This Week</option>
                        <option value="this-month">This Month</option>
                        <option value="last-30-days">Last 30 Days</option>
                    </select>
                </div>
                <div id="groupActivitiesSummary">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <!-- Detailed Student View -->
            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-header">
                    <div class="card-title">
                        <span>üéì</span>
                        <span>Student Activity Details</span>
                    </div>
                    <select class="form-select" id="activitiesGroupFilter" onchange="loadActivitiesSummary()">
                        <option value="">All Groups</option>
                    </select>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Group</th>
                                <th style="text-align: center;">Total Submissions</th>
                                <th style="text-align: center;">Avg Completion</th>
                                <th>Most Common Activities</th>
                            </tr>
                        </thead>
                        <tbody id="studentActivitiesBody">
                            <tr>
                                <td colspan="5" class="loading">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Activity Modal -->
    <div class="activity-modal-overlay" id="activityModalOverlay" onclick="closeActivityModalOnOverlay(event)">
        <div class="activity-modal-container">
            <button class="close-modal" onclick="closeActivityModal()">√ó</button>

            <div class="modal-header">
                <h2 class="modal-title" id="activityModalTitle">Add New Activity</h2>
                <p class="modal-subtitle">Create a custom activity for your group's cetele</p>
            </div>

            <form id="activityForm" onsubmit="submitActivityForm(event)">
                <div class="form-group">
                    <label for="activityName">Activity Name *</label>
                    <input
                        type="text"
                        id="activityName"
                        class="modal-input"
                        placeholder="e.g., Daily Quran Reading"
                        required
                        maxlength="100"
                    >
                </div>

                <div class="form-group">
                    <label for="activityDescription">Description (Optional)</label>
                    <textarea
                        id="activityDescription"
                        class="modal-textarea"
                        placeholder="Add details about this activity..."
                        rows="3"
                        maxlength="250"
                    ></textarea>
                    <div class="char-count">
                        <span id="charCount">0</span>/250 characters
                    </div>
                </div>

                <div class="form-group">
                    <label for="activityResponseType">Input Type *</label>
                    <select id="activityResponseType" class="modal-select" required onchange="toggleTargetFields()">
                        <option value="checkbox">Yes/No (Checkbox)</option>
                        <option value="number">Number (e.g., minutes, count)</option>
                    </select>
                    <div class="field-hint">
                        Choose how students will respond to this activity on their cetele
                    </div>
                </div>

                <div id="targetFieldsContainer" class="form-group" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label for="activityTarget">Target Goal</label>
                            <input type="number" id="activityTarget" class="modal-input" placeholder="e.g., 35" min="1">
                            <div class="field-hint">The goal students should aim for</div>
                        </div>
                        <div>
                            <label for="activityUnit">Unit</label>
                            <input type="text" id="activityUnit" class="modal-input" placeholder="e.g., pages, minutes">
                            <div class="field-hint">Unit of measurement</div>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeActivityModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn-submit" id="activitySubmitBtn">
                        ‚úì Create Activity
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/supabase-config.js"></script>
    <script src="js/db-helper.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/admin-new-fixed.js"></script>

    <!-- Mobile Sidebar Toggle -->
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const menuBtn = document.getElementById('mobileMenuBtn');

            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
            menuBtn.classList.toggle('active');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const menuBtn = document.getElementById('mobileMenuBtn');

            sidebar.classList.remove('open');
            overlay.classList.remove('active');
            menuBtn.classList.remove('active');
        }

        // Close sidebar when clicking a nav item on mobile
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (window.innerWidth <= 1024) {
                    closeSidebar();
                }
            });
        });

        // Close sidebar on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeSidebar();
            }
        });
    </script>
</body>
</html>
